---
project: "draft"
module: "root"
generated_by: "draft:init"
generated_at: "2026-02-15T09:03:18Z"
git:
  branch: "main"
  remote: "origin/main"
  commit: "22bc5fd8f630421d6d64d621708257cc26eb5d60"
  commit_short: "22bc5fd"
  commit_date: "2026-02-15 00:38:27 -0800"
  commit_message: "fix(new-track): add metadata.json write verification before tracks.md update"
  dirty: true
synced_to_commit: "22bc5fd8f630421d6d64d621708257cc26eb5d60"
---

# draft

> Self-contained AI context. 200-400 lines. Token-optimized.
> This file must stand alone — no references to architecture.md or source files needed.

| Field | Value |
|-------|-------|
| **Branch** | `main` → `origin/main` |
| **Commit** | `22bc5fd` — fix(new-track): add metadata.json write verification before tracks.md update |
| **Generated** | 2026-02-15T09:03:18Z |
| **Synced To** | `22bc5fd8f630421d6d64d621708257cc26eb5d60` |

---

## Architecture

- **Type**: Claude Code plugin (document-driven, no runtime process)
- **Language**: Markdown (skill definitions, ~12,000 lines), Bash (build/test, ~762 lines)
- **Pattern**: Convention-over-configuration plugin system
- **Build**: `make build` or `./scripts/build-integrations.sh`
- **Test**: `make test` or `./tests/test-build-integrations.sh`
- **Entry**: `.claude-plugin/plugin.json` → Claude Code auto-discovers `skills/*/SKILL.md`
- **Config**: YAML frontmatter in SKILL.md (name, description)
- **Generational**: single generation

## Component Graph

```
draft/
├── .claude-plugin/       ← Plugin manifest (plugin.json, marketplace.json)
├── skills/               ← 15 slash command implementations (SKILL.md per command)
│   ├── init/             ← Project initialization (1971 lines, largest skill)
│   ├── bughunt/          ← 12-dimension bug discovery (985 lines)
│   ├── validate/         ← Quality validation, 5 categories (869 lines)
│   ├── index/            ← Monorepo service aggregation (794 lines)
│   ├── review/           ← Three-stage code review (730 lines)
│   ├── new-track/        ← Collaborative spec + plan creation (567 lines)
│   ├── jira-preview/     ← Jira export generation (457 lines)
│   ├── implement/        ← TDD task execution (417 lines)
│   ├── decompose/        ← Module decomposition (328 lines)
│   ├── jira-create/      ← Jira issue creation via MCP (297 lines)
│   ├── adr/              ← Architecture Decision Records (237 lines)
│   ├── coverage/         ← Code coverage reporting (184 lines)
│   ├── revert/           ← Git-aware rollback (147 lines)
│   ├── status/           ← Progress overview (133 lines)
│   └── draft/            ← Methodology overview (101 lines)
├── core/
│   ├── methodology.md    ← Master methodology, source of truth (1212 lines)
│   ├── knowledge-base.md ← Vetted citation sources (127 lines)
│   ├── agents/           ← 5 behavioral protocols (architect, debugger, planner, rca, reviewer)
│   └── templates/        ← 16 output structure templates for user's draft/ directory
├── scripts/
│   └── build-integrations.sh ← Generates Copilot + Gemini integrations (642 lines)
├── tests/
│   └── test-build-integrations.sh ← Build verification (120 lines, 13 tests)
├── integrations/
│   ├── copilot/.github/copilot-instructions.md ← GENERATED, never edit
│   └── gemini/GEMINI.md                        ← GENERATED, never edit
├── index.html            ← Landing page (getdraft.dev)
├── CLAUDE.md             ← Repository instructions
└── README.md             ← Project overview
```

## Dependency Injection / Wiring

No runtime DI. Components connect through document references:
- Skills reference templates by path: `core/templates/<name>.md`
- Skills embed agent behaviors: `core/agents/<name>.md`
- Build script reads skills + core, outputs integrations
- methodology.md is source of truth; skills derive from it; integrations derive from skills

Key reference chains:
- `methodology.md` → `skills/*/SKILL.md` → `integrations/*/`
- `architecture.md` → `.ai-context.md` (via Condensation Subroutine)
- `templates/*.md` → user's `draft/*.md` (structural guidance)

## Critical Invariants (DO NOT BREAK)

- [Data] **Frontmatter required**: Every SKILL.md must have `name:` and `description:` in YAML frontmatter — enforced at `build-integrations.sh:139-147`
- [Data] **Body format**: After frontmatter: blank line, `# Title`, blank line — enforced at `build-integrations.sh:482-495`
- [Data] **tracks.md preserved**: Init never overwrites existing tracks.md — enforced at `skills/init/SKILL.md`
- [Data] **metadata before tracks**: metadata.json must be written before tracks.md update — enforced at `skills/new-track/SKILL.md`
- [Build] **No /draft: in output**: Integration files must use platform syntax — enforced at `build-integrations.sh:580-588`
- [Build] **No @draft in Copilot**: Copilot uses bare `draft ` — enforced at `build-integrations.sh:593-602`
- [Build] **Skill name regex**: `[a-z0-9-]+` only, prevents path traversal — enforced at `build-integrations.sh:474-478`
- [Build] **Integrations are generated**: Never edit copilot-instructions.md or GEMINI.md directly
- [Build] **Idempotent builds**: Same input → same output — enforced at `tests/test-build-integrations.sh:88-97`
- [Method] **No [x] without evidence**: Verification must run before marking complete — `methodology.md:1028-1040`
- [Method] **No fix without root cause**: Debugger iron law — `agents/debugger.md:12`
- [Method] **architecture.md primary**: .ai-context.md is derived via condensation, not manually edited

## Interface Contracts

```
// Skill File Interface
SKILL.md {
  frontmatter: { name: string, description: string }  // YAML between --- delimiters
  body: blank_line + "# Title" + blank_line + instructions  // Markdown
}

// Metadata JSON Interface
metadata.json {
  id: string           // kebab-case track ID
  title: string        // human-readable
  type: "feature"|"bugfix"|"refactor"
  status: "planning"|"in_progress"|"completed"
  phases: { total: int, completed: int }
  tasks: { total: int, completed: int }
  reviewCount: int
  lastReviewVerdict: "PASS"|"PASS_WITH_NOTES"|"FAIL"
}

// Status Markers (in plan.md, spec.md)
"[ ]" = pending, "[~]" = in_progress, "[x]" = completed, "[!]" = blocked
```

## Dependency Graph

```
[skills/*] --> (file ref) --> [core/templates/*]
[skills/*] --> (behavior ref) --> [core/agents/*]
[skills/*] --> (principle ref) --> [core/methodology.md]
[build-integrations.sh] --> (read) --> [skills/*]
[build-integrations.sh] --> (read) --> [core/*]
[build-integrations.sh] --> (write) --> [integrations/copilot/]
[build-integrations.sh] --> (write) --> [integrations/gemini/]
[Claude Code] --> (auto-discover) --> [.claude-plugin/plugin.json]
[Claude Code] --> (auto-discover) --> [skills/*/SKILL.md]
```

## Key Data Sources

| Source | Type | Readers |
|--------|------|---------|
| `skills/*/SKILL.md` | Skill files | Claude Code, build-integrations.sh |
| `core/methodology.md` | Reference | build-integrations.sh, all skills (via inlining) |
| `core/agents/*.md` | Agent behaviors | build-integrations.sh, skills that activate agents |
| `core/templates/*.md` | Output templates | build-integrations.sh, skills that generate files |
| User's `draft/*.md` | Project context | new-track, implement, validate, bughunt, review |
| User's `draft/tracks/*/` | Track state | implement, status, review, revert |

## Data Flow Summary

**Build Flow**: build-integrations.sh reads skills/*.md + core/*.md, strips frontmatter, applies platform-specific sed transforms (/draft:X → @draft X for Gemini, /draft:X → draft X for Copilot), inlines core files wrapped in <core-file> tags, verifies no /draft: syntax remains in output.

**Init Flow**: User invokes /draft:init → 5-phase codebase analysis (Discovery, Wiring, Depth, Periphery, Synthesis) → generates draft/architecture.md (30-45 pages) → Condensation Subroutine → generates draft/.ai-context.md (200-400 lines) → product/tech-stack/workflow dialogue → writes all draft/ files.

**Track Flow**: /draft:new-track → 6-phase intake dialogue → spec.md + plan.md + metadata.json → /draft:implement → TDD per task (RED→GREEN→REFACTOR) → phase boundary review → track completion.

## Error Handling & Failure Recovery

- **Malformed frontmatter**: build script exits with file path + field name
- **Invalid body format**: build script shows expected vs actual lines
- **Invalid skill name**: regex check fails, script exits
- **Missing skill/core file**: WARNING to stderr, continues
- **Syntax in output**: verify_output() catches, returns non-zero
- **set -euo pipefail**: immediate exit on any unhandled error
- **Skill red flags**: each skill defines stop conditions AI must check

## Concurrency Safety Rules

Single-threaded. No concurrency concerns.
- Build script: sequential (Copilot → verify → Gemini → verify)
- Skill execution: within Claude Code's single-conversation context

## Implementation Catalog

### Skills (15)

| Name | Category | Lines | Purpose |
|------|----------|-------|---------|
| `init` | Setup | 1971 | Project init + 5-phase architecture discovery |
| `bughunt` | Quality | 985 | 12-dimension exhaustive bug discovery |
| `validate` | Quality | 869 | 5-category quality validation |
| `index` | Setup | 794 | Monorepo service aggregation |
| `review` | Quality | 730 | Three-stage code review |
| `new-track` | Planning | 567 | Collaborative spec + plan creation |
| `jira-preview` | Integration | 457 | Jira export generation |
| `implement` | Execution | 417 | TDD task execution |
| `decompose` | Planning | 328 | Module decomposition |
| `jira-create` | Integration | 297 | Jira issue creation via MCP |
| `adr` | Planning | 237 | Architecture Decision Records |
| `coverage` | Execution | 184 | Code coverage reporting |
| `revert` | Management | 147 | Git-aware rollback |
| `status` | Management | 133 | Progress overview |
| `draft` | Meta | 101 | Overview + command listing |

### Agents (5)

| Name | Lines | Activator | Purpose |
|------|-------|-----------|---------|
| `architect` | 336 | decompose, implement | Modules, stories, skeletons |
| `rca` | 253 | new-track (bug) | Root cause analysis |
| `reviewer` | 165 | implement | Phase boundary review |
| `planner` | 145 | new-track, decompose | Plan generation |
| `debugger` | 114 | implement ([!] tasks) | Systematic debugging |

## Key Configuration

| Param | Default | Critical? | Purpose |
|-------|---------|-----------|---------|
| `SKILL_ORDER` | 15 skills | Yes | Controls skill inclusion in integrations |
| `CORE_FILES` | 21 files | Yes | Core files inlined into integrations |
| `name` in frontmatter | per-skill | Yes | Becomes /draft:<name> command |
| `description` in frontmatter | per-skill | Yes | Shown in plugin listing |
| Plugin version | 1.3.0 | No | In plugin.json |

## Extension Points — Step-by-Step Cookbooks

### Adding a New Skill

1. Create `skills/<name>/SKILL.md` with frontmatter (name + description)
2. Body format: blank line, `# Title`, blank line, instructions
3. Add to `SKILL_ORDER` array in `build-integrations.sh:30-46`
4. Add to `get_skill_header()` case at `build-integrations.sh:48-68`
5. Add to `get_gemini_trigger()` case at `build-integrations.sh:71-91`
6. Add to `get_copilot_trigger()` case at `build-integrations.sh:94-114`
7. Run `make build && make test`

### Adding a New Agent

1. Create `core/agents/<name>.md` with frontmatter (description, capabilities)
2. Reference from relevant skill(s)
3. Add to `CORE_FILES` array in `build-integrations.sh:187-213`
4. Document in `core/methodology.md` under Agents section
5. Run `make build`

### Adding a New Template

1. Create `core/templates/<name>.md` with standard metadata header
2. Reference from relevant skill(s)
3. Add to `CORE_FILES` if needed by integrations
4. Run `make build`

## Testing Strategy

- **Unit**: `./tests/test-build-integrations.sh` (13 tests, <2s runtime)
- **Categories**: existence (2), copilot output (6), gemini output (4), idempotency (1)
- **Hooks**: assert() fn with pass/fail counting, exit code = failure count
- **NOT tested**: skill content correctness, frontmatter validation edge cases

## File Layout Quick Reference

- Entry: `.claude-plugin/plugin.json`
- Config: YAML frontmatter in `skills/*/SKILL.md`
- Skills: `skills/*/SKILL.md`
- Agents: `core/agents/*.md`
- Templates: `core/templates/*.md`
- Methodology: `core/methodology.md`
- Build: `scripts/build-integrations.sh`
- Tests: `tests/test-build-integrations.sh`
- Generated: `integrations/copilot/`, `integrations/gemini/`

## Glossary (Critical Terms Only)

| Term | Definition |
|------|------------|
| Track | Unit of work (feature/bug/refactor) with spec.md, plan.md, metadata.json |
| Skill | SKILL.md file defining a /draft:* command's execution instructions |
| Agent | Behavioral protocol in core/agents/ activating during workflow phases |
| Template | Structure definition in core/templates/ for generated files |
| Condensation | Process transforming architecture.md into token-optimized .ai-context.md |
| Status marker | `[ ]` pending, `[~]` in progress, `[x]` complete, `[!]` blocked |
| Iron law | Inviolable principle (e.g., no fix without root cause) |
| Architecture mode | Enhanced impl workflow when architecture.md exists for track |
| SKILL_ORDER | Array in build script controlling skill inclusion order |

## Draft Integration

- See `draft/tech-stack.md` for accepted patterns and technology decisions
- See `draft/workflow.md` for TDD preferences and guardrails
- See `draft/product.md` for product context and guidelines
